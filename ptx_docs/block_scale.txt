The tcgen05.mma instructions with the following .kind qualifier:

    .kind::mxf8f6f4

    .kind::mxf4

    .kind::mxf4nvf4

perform matrix multiplication with block scaling. This operation has the following form:

(A * scale_A)  * (B * scale_B) + D

where scale_A and scale_B are matrices residing in Tensor Memory.

For a scale_A matrix of shape M x SFA_N, each row of matrix A is divided into SFA_N number of chunks and each chunk of a row is multiplied with the corresponding element in the SF_A of the same row.

Similarly, for a scale_B matrix of shape SFB_M x N, each column of matrix B is divided into the SFB_M number of chunks and each chunk of a column is multiplied with the corresponding element in the SF_B of the same column.

Scale factors for A and B matrices need to be duplicated to all 32 lane partitions of tensor memory.

Figure 230 shows an example of tcgen05.mma with block scaling of scale_vec::2X.
_images/tcgen05-mma-block-scaling.png

Figure 230 tcgen05.mma with block scaling of scale_vec::2X
9.7.16.10.7.1. Valid combinations of scale_vectorsize with types and MMA-Kind

The shape of scale_A and scale_B matrices depend on the .scale_vectorsize as shown in Table 54.
Table 54 Valid combinations of scale_vectorsize and shapes

.scale_vectorsize
	

.kind::*
	

K
	

Shape of scale_A
	

Shape of scale_B

.scale_vec::1X
	

.kind::mxf8f6f4
	

All supported values of K
	

M x 1
	

1 x N

.scale_vec::2X
	

.kind::mxf4, .kind::mxf4nvf4
	

All supported values of K
	

M x 2
	

2 x N

.scale_vec::4X
	

.kind::mxf4nvf4
	

All supported values of K
	

M x 4
	

4 x N

.block16
	

.kind::mxf4nvf4
	

K = 96
	

M x 6
	

6 x N

All supported values of K except 96
	

M x 4
	

4 x N

.block32
	

.kind::mxf4, .kind::mxf4nvf4
	

K = 96
	

M x 3
	

3 x N

All supported values of K except 96
	

M x 2
	

2 x N

.kind::mxf8f6f4
	

All supported values of K
	

M x 1
	

1 x N

The valid combination of the exact element types and the .scale_vectorsize are listed in Table 55.
Table 55 Valid combinations of scale_vectorsize with types and MMA-Kind

.kind::*
	

Element Data Type
	

Scale Data Type
	

.scale_vectorsize

.kind::mxf8f6f4
	

E4M3, E5M2, E2M3 E3M2, E2M1
	

UE8M0
	

.scale_vec::1X / .block32

.kind::mxf4
	

E2M1
	

UE8M0
	

.scale_vec::2X / .block32

.kind::mxf4nvf4
	

E2M1
	

UE8M0
	

.scale_vec::2X / .block32, .scale_vec::4X / .block16

E2M1
	

UE4M3
	

.scale_vec::4X / .block16

New .blockN qualifiers are aliases for .scale_vec::NX qualifiers as:

    .block32 is alias for .scale_vec::1X or .scale_vec::2X based on .kind and K dimension

    .block16 is alias for .scale_vec::4X

9.7.16.10.7.2. Scale Factor A ID

The value of the scale factor A ID selects the sub-columns in the Tensor Memory to form the scale factor A matrix, which is used to scale the matrix A.

The following shows the scale factor matrix layout for various scale vector sizes:
9.7.16.10.7.2.1. Layout of the Scale Factor A Matrix for scale_vec::1X/block32 with K=32/K=64

There is one scale factor per row of the A matrix with block size as 32 and the scale factor must be provided in 1-byte aligned sub-column of the Tensor Memory. SFA_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 231 shows which sub-columns get selected for different values of SFA_ID.
_images/tcgen05-mma-scale-factor-a-1x-dig.png

Figure 231 Layout of scale factor A matrix with scale_vec::1X/block32 with K=32/K=64

For example, if SFA_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, SFA_ID values of 1, 2 and 3 would select the blue, yellow, and red columns, respectively.
9.7.16.10.7.2.2. Layout of the Scale Factor A Matrix for scale_vec::2X/block32 with K=64/K=128

There are two scale factors per row of the A matrix with block size as 32 and the scale factor must be provided in 2-byte aligned sub-column of the Tensor Memory. SFA_ID specifies the half word offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 232 shows which sub-columns gets selected for different values of SFA_ID.
_images/tcgen05-mma-scale-factor-a-2x-dig.png

Figure 232 Layout of scale factor A matrix with scale_vec::2X/block32 with K=64/K=128

For example, if SFA_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, if SFA_ID is 2, then all of the blue columns are selected to form the scale factor matrix.
9.7.16.10.7.2.3. Layout of the Scale Factor A Matrix for scale_vec::4X/block16 with K=64/K=128

There are four scale factors per row of the A matrix with block size as 16 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. The SFA_ID value must be 0 and this specifies that all of the columns (in green) will be used for the scale factor matrix. Figure 233 shows which sub-columns gets selected for different values of SFA_ID.
_images/tcgen05-mma-scale-factor-a-4x-dig.png

Figure 233 Layout of scale factor A matrix with scale_vec::4X/block16 with K=64/K=128
9.7.16.10.7.2.4. Layout of the Scale Factor A Matrix for block32 with K=96 (Semantically equivalent to scale_vec::3X)

There are three scale factors per row of the A matrix with block size as 32 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. SFA_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 234, Figure 235, Figure 236 and Figure 237 show which sub-columns get selected for different values of SFA_ID.
_images/tcgen05-mma-scale-factor-a-block32-k96-dig1.png

Figure 234 Layout of scale factor A matrix with block32 with K=96 with SFA_ID=00
_images/tcgen05-mma-scale-factor-a-block32-k96-dig2.png

Figure 235 Layout of scale factor A matrix with block32 with K=96 with SFA_ID=01
_images/tcgen05-mma-scale-factor-a-block32-k96-dig3.png

Figure 236 Layout of scale factor A matrix with block32 with K=96 with SFA_ID=10
_images/tcgen05-mma-scale-factor-a-block32-k96-dig4.png

Figure 237 Layout of scale factor A matrix with block32 with K=96 with SFA_ID=11

For example, if SFA_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, SFA_ID values of 1, 2 and 3 would select the blue, yellow, and red columns, respectively.
9.7.16.10.7.2.5. Layout of the Scale Factor A Matrix for block16 with K=96 (Semantically equivalent to scale_vec::6X)

There are six scale factors per row of the A matrix with block size as 16 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. SFA_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 238 and Figure 239 show which sub-columns get selected for different values of SFA_ID.
_images/tcgen05-mma-scale-factor-a-block16-k96-dig1.png

Figure 238 Layout of scale factor A matrix with block16 with K=96 with SFA_ID=00
_images/tcgen05-mma-scale-factor-a-block16-k96-dig2.png

Figure 239 Layout of scale factor A matrix with block16 with K=96 with SFA_ID=10

For example, if SFA_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, if SFA_ID is 2, then all of the blue columns are selected to form the scale factor matrix.
9.7.16.10.7.3. Scale Factor B ID

The value of the scale factor B ID selects the sub-columns in the Tensor Memory to form the scale factor B matrix, which is used to scale the matrix B.

The following shows the scale factor matrix layout for various scale vector sizes:
9.7.16.10.7.3.1. Layout of the Scale Factor B Matrix for scale_vec::1X/block32 with K=32/K=64

There is one scale factor per row of the B matrix with block size as 32 and the scale factor must be provided in 1-byte aligned sub-column of the Tensor Memory. SFB_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 240 shows which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-1x-dig.png

Figure 240 Layout of scale factor B matrix with scale_vec::1X/block32 with K=32/K=64

For example, if SFB_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, SFB_ID values of 1, 2 and 3 would select the blue, yellow, and red columns, respectively.
9.7.16.10.7.3.2. Layout of the Scale Factor B Matrix for scale_vec::2X/block32 with K=64/K=128

There are two scale factors per row of the B matrix with block size as 32 and the scale factor must be provided in 2-byte aligned sub-column of the Tensor Memory. SFB_ID specifies the half word offset in the Tensor Memory word that must be used for the scale factor matrix. Figure 241 shows which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-2x-dig.png

Figure 241 Layout of scale factor B matrix with scale_vec::2X/block32 with K=64/K=128

For example, if SFB_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, if SFB_ID is 2, then all of the blue columns are selected to form the scale factor matrix.
9.7.16.10.7.3.3. Layout of the Scale Factor B Matrix for scale_vec::4X/block16 with K=64/K=128

There are four scale factors per row of the B matrix with block size as 16 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. The SFB_ID value must be 0 and this specifies that all of the columns (in green) will be used for the scale factor matrix. Figure 242 shows which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-4x-dig.png

Figure 242 Layout of scale factor B matrix with scale_vec::4X/block16 with K=64/K=128
9.7.16.10.7.3.4. Layout of the Scale Factor B Matrix for block32 with K=96 (Semantically equivalent to scale_vec::3X)

There are three scale factors per row of the B matrix with block size as 32 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. SFB_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix.

For N<=128, Figure 243, Figure 244, Figure 245 and Figure 246 show which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-block32-k96-nlt128-dig1.png

Figure 243 Layout of scale factor B matrix with block32 with K=96 and N<=128 with SFA_ID=00
_images/tcgen05-mma-scale-factor-b-block32-k96-nlt128-dig2.png

Figure 244 Layout of scale factor B matrix with block32 with K=96 and N<=128 with SFA_ID=01
_images/tcgen05-mma-scale-factor-b-block32-k96-nlt128-dig3.png

Figure 245 Layout of scale factor B matrix with block32 with K=96 and N<=128 with SFA_ID=10
_images/tcgen05-mma-scale-factor-b-block32-k96-nlt128-dig4.png

Figure 246 Layout of scale factor B matrix with block32 with K=96 and N<=128 with SFA_ID=11

For N>128, Figure 247, Figure 248, Figure 249, Figure 250, Figure 251 and Figure 252 show which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig1.png

Figure 247 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=00
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig2.png

Figure 248 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=01
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig3.png

Figure 249 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=10
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig4.png

Figure 250 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=10
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig5.png

Figure 251 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=11
_images/tcgen05-mma-scale-factor-b-block32-k96-ngt128-dig6.png

Figure 252 Layout of scale factor B matrix with block32 with K=96 and N>128 with SFA_ID=11

For example, if SFB_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, SFB_ID values of 1, 2 and 3 would select the blue, yellow, and red columns, respectively.
9.7.16.10.7.3.5. Layout of the Scale Factor B Matrix for block16 with K=96 (Semantically equivalent to scale_vec::6X)

There are six scale factors per row of the B matrix with block size as 16 and the scale factor must be provided in 4-byte aligned sub-column of the Tensor Memory. SFB_ID specifies the byte offset in the Tensor Memory word that must be used for the scale factor matrix.

For N<=128, Figure 253 and Figure 254 show which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-block16-k96-nlt128-dig1.png

Figure 253 Layout of scale factor B matrix with block16 with K=96 and N<=128 with SFA_ID=00
_images/tcgen05-mma-scale-factor-b-block16-k96-nlt128-dig2.png

Figure 254 Layout of scale factor B matrix with block16 with K=96 and N<=128 with SFA_ID=10

For N>128, Figure 255, Figure 256, Figure 257 and Figure 258 show which sub-columns get selected for different values of SFB_ID.
_images/tcgen05-mma-scale-factor-b-block16-k96-ngt128-dig1.png

Figure 255 Layout of scale factor B matrix with block16 with K=96 and N>128 with SFA_ID=00
_images/tcgen05-mma-scale-factor-b-block16-k96-ngt128-dig2.png

Figure 256 Layout of scale factor B matrix with block16 with K=96 and N>128 with SFA_ID=00
_images/tcgen05-mma-scale-factor-b-block16-k96-ngt128-dig3.png

Figure 257 Layout of scale factor B matrix with block16 with K=96 and N>128 with SFA_ID=10
_images/tcgen05-mma-scale-factor-b-block16-k96-ngt128-dig4.png

Figure 258 Layout of scale factor B matrix with block16 with K=96 and N>128 with SFA_ID=10

For example, if SFB_ID is 0, then all the green columns are selected to form the scale factor matrix. Similarly, if SFB_ID is 2, then all of the blue columns are selected to form the scale factor matrix.
9.7.16.10.8. Sparse Matrices

This instruction tcgen05.mma.sp can be used when the matrix A is a structured sparse matrix with 50% zeros in each row distributed as per its sparse granularity.

In a MxNxK sparse tcgen05.mma.sp operation, the matrix A of shape MxK is stored in a packed form as Mx(K/2) in memory. For each K-wide row of matrix A, 50% of elements are zeros and the remaining K/2 non-zero elements are stored in memory. The metadata specifies the mapping of the K/2 non-zero elements to the K elements before performing the MMA operation.

Granularity of sparse matrix A is defined as the ratio of the number of non-zero elements in a sub-chunk of the matrix row to the total number of elements in that sub-chunk where the size of the sub-chunk is shape-specific. The following table lists the granularity of different tcgen05.mma.sp variants:

.kind of tcgen05.mma
	

Sparse Granularity

.kind::tf32
	

1:2

.kind::f16
	

2:4

.kind::f8f6f4

.kind::mxf8f6f4

.kind::i8

.kind::mxf4
	

4:8 (in pairs)