## 11.4. Performance-Tuning Directives 

To provide a mechanism for low-level performance tuning, PTX supports the following directives,
which pass information to the optimizing backend compiler.

* `.maxnreg`
* `.maxntid`
* `.reqntid`
* `.minnctapersm`
* `.maxnctapersm` (deprecated)
* `.pragma`
* `.abi_preserve`
* `.abi_preserve_control`

The `.maxnreg` directive specifies the maximum number of registers to be allocated to a single
thread; the `.maxntid` directive specifies the maximum number of threads
in a thread block (CTA); the `.reqntid` directive specifies the required number of threads in a
thread block (CTA); and the `.minnctapersm` directive specifies a minimum number of thread blocks
to be scheduled on a single multiprocessor (SM). These can be used, for example, to throttle the
resource requirements (e.g., registers) to increase total thread count and provide a greater
opportunity to hide memory latency. The `.minnctapersm` directive can be used together with either
the `.maxntid` or `.reqntid` directive to trade-off registers-per-thread against multiprocessor
utilization without needed to directly specify a maximum number of registers. This may achieve better
performance when compiling PTX for multiple devices having different numbers of registers per SM.

Device function directives `.abi_preserve` and `.abi_preserve_control` specify number of data
and control registers from callee save registers that a function must preserve for its caller. This
can be considered to be the number of general purpose and control registers live in the caller when function
is called. Control registers refer to the number of divergent program points that happen in the calltree
leading to current function call.

Currently, the `.maxnreg`, `.maxntid`, `.reqntid`, and `.minnctapersm`
directives may be applied per-entry and must appear between an `.entry` directive and its body.
The directives take precedence over any module-level constraints passed to the optimizing backend.
A warning message is generated if the directives’ constraints are inconsistent or cannot be met
for the specified target device.

A general `.pragma` directive is supported for passing information to the PTX backend. The
directive passes a list of strings to the backend, and the strings have no semantics within the PTX
virtual machine model. The interpretation of `.pragma` values is determined by the backend
implementation and is beyond the scope of the PTX ISA. Note that `.pragma` directives may appear
at module (file) scope, at entry-scope, or as statements within a kernel or device function body.

### 11.4.1. [Performance-Tuning Directives: `.maxnreg`](#performance-tuning-directives-maxnreg)[](#performance-tuning-directives-maxnreg "Permalink to this headline")

`.maxnreg`

Maximum number of registers that can be allocated per thread.

Syntax

```
.maxnreg n
```

Description

Declare the maximum number of registers per thread in a CTA.

Semantics

The compiler guarantees that this limit will not be exceeded. The actual number of registers used
may be less; for example, the backend may be able to compile to fewer registers, or the maximum
number of registers may be further constrained by `.maxntid` and `.maxctapersm`.

PTX ISA Notes

Introduced in PTX ISA version 1.3.

Target ISA Notes

Supported on all target architectures.

Examples

```
.entry foo .maxnreg 16 { ... }  // max regs per thread = 16
```

### 11.4.2. [Performance-Tuning Directives: `.maxntid`](#performance-tuning-directives-maxntid)[](#performance-tuning-directives-maxntid "Permalink to this headline")

`.maxntid`

Maximum number of threads in the thread block (CTA).

Syntax

```
.maxntid nx

.maxntid nx, ny

.maxntid nx, ny, nz
```

Description

Declare the maximum number of threads in the thread block (CTA). This maximum is specified by giving
the maximum extent of each dimension of the 1D, 2D, or 3D CTA. The maximum number of threads is the
product of the maximum extent in each dimension.

Semantics

The maximum number of threads in the thread block, computed as the product of the maximum extent
specified for each dimension, is guaranteed not to be exceeded in any invocation of the kernel in
which this directive appears. Exceeding the maximum number of threads results in a runtime error or
kernel launch failure.

Note that this directive guarantees that the *total* number of threads does not exceed the maximum,
but does not guarantee that the limit in any particular dimension is not exceeded.

PTX ISA Notes

Introduced in PTX ISA version 1.3.

Target ISA Notes

Supported on all target architectures.

Examples

```
.entry foo .maxntid 256       { ... }  // max threads = 256

.entry bar .maxntid 16,16,4   { ... }  // max threads = 1024
```

### 11.4.3. [Performance-Tuning Directives: `.reqntid`](#performance-tuning-directives-reqntid)[](#performance-tuning-directives-reqntid "Permalink to this headline")

`.reqntid`

Number of threads in the thread block (CTA).

Syntax

```
.reqntid nx

.reqntid nx, ny

.reqntid nx, ny, nz
```

Description

Declare the number of threads in the thread block (CTA) by specifying the extent of each dimension
of the 1D, 2D, or 3D CTA. The total number of threads is the product of the number of threads in
each dimension.

Semantics

The size of each CTA dimension specified in any invocation of the kernel is required to be equal to
that specified in this directive. Specifying a different CTA dimension at launch will result in a
runtime error or kernel launch failure.

Notes

The `.reqntid` directive cannot be used in conjunction with the `.maxntid` directive.

PTX ISA Notes

Introduced in PTX ISA version 2.1.

Target ISA Notes

Supported on all target architectures.

Examples

```
.entry foo .reqntid 256       { ... }  // num threads = 256

.entry bar .reqntid 16,16,4   { ... }  // num threads = 1024
```

### 11.4.4. [Performance-Tuning Directives: `.minnctapersm`](#performance-tuning-directives-minnctapersm)[](#performance-tuning-directives-minnctapersm "Permalink to this headline")

`.minnctapersm`

Minimum number of CTAs per SM.

Syntax

```
.minnctapersm ncta
```

Description

Declare the minimum number of CTAs from the kernel’s grid to be mapped to a single multiprocessor
(SM).

Notes

Optimizations based on `.minnctapersm` need either `.maxntid` or `.reqntid` to be specified as
well.

If the total number of threads on a single SM resulting from `.minnctapersm` and `.maxntid` /
`.reqntid` exceed maximum number of threads supported by an SM then directive `.minnctapersm`
will be ignored.

In PTX ISA version 2.1 or higher, a warning is generated if `.minnctapersm` is specified without
specifying either `.maxntid` or `.reqntid`.

PTX ISA Notes

Introduced in PTX ISA version 2.0 as a replacement for `.maxnctapersm`.

Target ISA Notes

Supported on all target architectures.

Examples

```
.entry foo .maxntid 256 .minnctapersm 4 { ... }
```

### 11.4.5. [Performance-Tuning Directives: `.maxnctapersm` (deprecated)](#performance-tuning-directives-maxnctapersm)[](#performance-tuning-directives-maxnctapersm "Permalink to this headline")

`.maxnctapersm`

Maximum number of CTAs per SM.

Syntax

```
.maxnctapersm ncta
```

Description

Declare the maximum number of CTAs from the kernel’s grid that may be mapped to a single
multiprocessor (SM).

Notes

Optimizations based on .maxnctapersm generally need `.maxntid` to be specified as well. The
optimizing backend compiler uses `.maxntid` and `.maxnctapersm` to compute an upper-bound on
per-thread register usage so that the specified number of CTAs can be mapped to a single
multiprocessor. However, if the number of registers used by the backend is sufficiently lower than
this bound, additional CTAs may be mapped to a single multiprocessor. For this reason,
`.maxnctapersm` has been renamed to .minnctapersm in PTX ISA version 2.0.

PTX ISA Notes

Introduced in PTX ISA version 1.3. Deprecated in PTX ISA version 2.0.

Target ISA Notes

Supported on all target architectures.

Examples

```
.entry foo .maxntid 256 .maxnctapersm 4 { ... }
```

### 11.4.6. [Performance-Tuning Directives: `.noreturn`](#performance-tuning-directives-noreturn)[](#performance-tuning-directives-noreturn "Permalink to this headline")

`.noreturn`

Indicate that the function does not return to its caller function.

Syntax

```
.noreturn
```

Description

Indicate that the function does not return to its caller function.

Semantics

An optional `.noreturn` directive indicates that the function does not return to caller
function. `.noreturn` directive can only be specified on device functions and must appear between
a `.func` directive and its body.

The directive cannot be specified on functions which have return parameters.

If a function with `.noreturn` directive returns to the caller function at runtime, then the
behavior is undefined.

PTX ISA Notes

Introduced in PTX ISA version 6.4.

Target ISA Notes

Requires `sm_30` or higher.

Examples

```
.func foo .noreturn { ... }
```

### 11.4.7. [Performance-Tuning Directives: `.pragma`](#performance-tuning-directives-pragma)[](#performance-tuning-directives-pragma "Permalink to this headline")

`.pragma`

Pass directives to PTX backend compiler.

Syntax

```
.pragma list-of-strings ;
```

Description

Pass module-scoped, entry-scoped, or statement-level directives to the PTX backend compiler.

The `.pragma` directive may occur at module-scope, at entry-scope, or at statement-level.

Semantics

The interpretation of `.pragma` directive strings is implementation-specific and has no impact on
PTX semantics. See [Descriptions of .pragma Strings](#descriptions-pragma-strings) for
descriptions of the pragma strings defined in `ptxas`.

PTX ISA Notes

Introduced in PTX ISA version 2.0.

Target ISA Notes

Supported on all target architectures.

Examples

```
.pragma "nounroll";    // disable unrolling in backend



// disable unrolling for current kernel

.entry foo .pragma "nounroll"; { ... }
```

### 11.4.8. [Performance-Tuning Directives: `.abi_preserve`](#performance-tuning-directives-abi-preserve)[](#performance-tuning-directives-abi-preserve "Permalink to this headline")

`.abi_preserve`

Specify number of general purpose registers that should be preserved by the callers of this function.

Syntax

```
.abi_preserve N
```

Description

It is an architecture agnostic value specifying actual number of general purpose registers.
Internally ABI defines some general purpose registers as preserved (callee save) registers.
Integer N specifies the actual number of general purpose registers that should be preserved by
the function.

`.abi_preserve` directive can only be specified on device functions and must appear between
a `.func` directive and its body.

Semantics

When this directive is specified compiler backend modifies low level ABI components to ensure that
number of live data variables in the callers of this function that are stored in the callee save
registers are less than specified value.

PTX ISA Notes

Introduced in PTX ISA version 9.0.

Target ISA Notes

Requires `sm_80` or higher.

Examples

```
.func bar() .abi_preserve 8



// Indirect call via call prototype

.func (.param .b32 out[30]) foo (.param .b32 in[30]) .abi_preserve 10 { ... }

...

mov.b64 lpfoo, foo;

prot: .callprototype (.param .b32 out[30]) _ (.param .b32 in[30]) .abi_preserve 10;

call (out), lpfoo, (in), prot;
```

### 11.4.9. [Performance-Tuning Directives: `.abi_preserve_control`](#performance-tuning-directives-abi-preserve-control)[](#performance-tuning-directives-abi-preserve-control "Permalink to this headline")

`.abi_preserve_control`

Specify number of control registers that should be preserved by the callers of this function.

Syntax

```
.abi_preserve_control N
```

Description

It is an architecture agnostic value specifying the number of divergent program points that happen
in the calltree leading to current function call.
Internally ABI defines some control registers as preserved (callee save) registers.
Integer N specifies the actual number of control registers that should be preserved by the function.

`.abi_preserve_control` directive can only be specified on device functions and must appear between
a `.func` directive and its body.

Semantics

When this directive is specified compiler backend modifies low level ABI components to ensure that
number of live control variables in the callers of this function that are stored in the callee save
control registers are less than specified value.

PTX ISA Notes

Introduced in PTX ISA version 9.0.

Target ISA Notes

Requires `sm_80` or higher.

Examples

```
.func foo() .abi_preserve_control 14



// Indirect call via call prototype

.func (.param .b32 out[30]) bar (.param .b32 in[30]) .abi_preserve_control 10 { ... }

...

mov.b64 lpbar, bar;

prot: .callprototype (.param .b32 out[30]) _ (.param .b32 in[30]) .abi_preserve_control 10;

call (out), lpbar, (in), prot;
```